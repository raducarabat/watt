services:
    postgres-auth:
        image: postgres:18-alpine
        restart: always
        environment:
            POSTGRES_DB: ${POSTGRES_AUTH_DB}
            POSTGRES_USER: ${POSTGRES_AUTH_USER}
            POSTGRES_PASSWORD: ${POSTGRES_AUTH_PASSWORD}
        volumes:
            - pgdata_auth:/var/lib/postgresql/data
        ports:
            - "${POSTGRES_AUTH_PORT}:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_AUTH_USER} -d ${POSTGRES_AUTH_DB}"]
            interval: 1s
            timeout: 5s
            retries: 10

    auth-svc:
        build: ./auth-svc
        environment:
            - DATABASE_URL=postgres://${POSTGRES_AUTH_USER}:${POSTGRES_AUTH_PASSWORD}@postgres-auth:5432/${POSTGRES_AUTH_DB}
            - RUST_LOG=info
        depends_on:
            postgres-auth:
                condition: service_healthy
        ports:
            - "${AUTH_SVC_PORT}:8080"

    postgres-device:
        image: postgres:18-alpine
        restart: always
        environment:
            POSTGRES_DB: ${POSTGRES_DEVICE_DB}
            POSTGRES_USER: ${POSTGRES_DEVICE_USER}
            POSTGRES_PASSWORD: ${POSTGRES_DEVICE_PASSWORD}
        volumes:
            - pgdata_device:/var/lib/postgresql/data
        ports:
            - "${POSTGRES_DEVICE_PORT}:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_DEVICE_USER} -d ${POSTGRES_DEVICE_DB}"]
            interval: 1s
            timeout: 5s
            retries: 10  

    device-svc:
        build: ./device-svc
        environment:
            - DATABASE_URL=postgres://${POSTGRES_DEVICE_USER}:${POSTGRES_DEVICE_PASSWORD}@postgres-device:5432/${POSTGRES_DEVICE_DB}
            - RUST_LOG=info
        depends_on:
            postgres-device:
                condition: service_healthy
        ports:
            - "${DEVICE_SVC_PORT}:8080"

    postgres-user:
        image: postgres:18-alpine
        restart: always
        environment:
            POSTGRES_DB: ${POSTGRES_USER_DB}
            POSTGRES_USER: ${POSTGRES_USER_USER}
            POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD}
        volumes:
            - pgdata_user:/var/lib/postgresql/data
        ports:
            - "${POSTGRES_USER_PORT}:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER_USER} -d ${POSTGRES_USER_DB}"]
            interval: 1s
            timeout: 5s
            retries: 10 

    user-svc:
        build: ./user-svc
        environment:
            - DATABASE_URL=postgres://${POSTGRES_USER_USER}:${POSTGRES_USER_PASSWORD}@postgres-user:5432/${POSTGRES_USER_DB}
            - RUST_LOG=info
        depends_on:
            postgres-user:
                condition: service_healthy
        ports:
            - "${USER_SVC_PORT}:8080"
    
    
volumes:
    pgdata_auth:
    pgdata_device:
    pgdata_user:
